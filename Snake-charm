#include <iostream>
#include <vector>
#include <cstdlib>
#include <ctime>
#include <unistd.h>

#if defined(_WIN32)
#include <conio.h>
#else
#include <termios.h>
#include <fcntl.h>
int kbhit(void) {
    termios oldt, newt;
    int ch;
    int oldf;
    tcgetattr(STDIN_FILENO, &oldt);
    newt = oldt;
    newt.c_lflag &= ~(ICANON | ECHO);
    tcsetattr(STDIN_FILENO, TCSANOW, &newt);
    oldf = fcntl(STDIN_FILENO, F_GETFL, 0);
    fcntl(STDIN_FILENO, F_SETFL, oldf | O_NONBLOCK);

    ch = getchar();

    tcsetattr(STDIN_FILENO, TCSANOW, &oldt);
    fcntl(STDIN_FILENO, F_SETFL, oldf);

    if(ch != EOF) {
        ungetc(ch, stdin);
        return 1;
    }
    return 0;
}
int getch() {
    return getchar();
}
#endif

using namespace std;

class SnakeGame {
private:
    const int width = 30;
    const int height = 20;

    int x, y;                 // Snake head position
    int foodX, foodY;         // Food position
    int score;
    bool gameOver;

    enum Direction { STOP = 0, LEFT, RIGHT, UP, DOWN };
    Direction dir;

    vector<pair<int,int>> snakeBody;

public:
    SnakeGame() {
        srand(time(NULL));
        reset();
    }

    void reset() {
        gameOver = false;
        dir = STOP;
        x = width / 2;
        y = height / 2;
        snakeBody.clear();
        snakeBody.push_back({x, y});
        generateFood();
        score = 0;
    }

    void generateFood() {
        foodX = rand() % width;
        foodY = rand() % height;
    }

    void draw() {
        system("clear||cls");

        for (int i = 0; i < width+2; i++) cout << "#";
        cout << "\n";

        for (int i = 0; i < height; i++) {
            for (int j = 0; j < width; j++) {
                if (j == 0) cout << "#";

                if (i == y && j == x)
                    cout << "O";                  // Snake head
                else if (i == foodY && j == foodX)
                    cout << "@";                  // Food
                else {
                    bool printed = false;
                    for (auto &s : snakeBody) {
                        if (s.first == j && s.second == i) {
                            cout << "o";          // Snake body
                            printed = true;
                        }
                    }
                    if (!printed) cout << " ";
                }

                if (j == width-1) cout << "#";
            }
            cout << "\n";
        }

        for (int i = 0; i < width+2; i++) cout << "#";
        cout << "\n";

        cout << "Score: " << score << "\n";
    }

    void input() {
        if (kbhit()) {
            switch(getch()) {
                case 'a': case 'A': dir = LEFT; break;
                case 'd': case 'D': dir = RIGHT; break;
                case 'w': case 'W': dir = UP; break;
                case 's': case 'S': dir = DOWN; break;
                case 'x': case 'X': gameOver = true; break;
            }
        }
    }

    void logic() {
        int prevX = x, prevY = y;
        int prev2X, prev2Y;

        switch(dir) {
            case LEFT:  x--; break;
            case RIGHT: x++; break;
            case UP:    y--; break;
            case DOWN:  y++; break;
            default: break;
        }

        // Wall collision
        if (x < 0 || x >= width || y < 0 || y >= height)
            gameOver = true;

        // Body movement
        for (int i = 1; i < snakeBody.size(); i++) {
            prev2X = snakeBody[i].first;
            prev2Y = snakeBody[i].second;
            snakeBody[i].first = prevX;
            snakeBody[i].second = prevY;
            prevX = prev2X;
            prevY = prev2Y;
        }
        snakeBody[0] = {x, y};

        // Self collision
        for (int i = 1; i < snakeBody.size(); i++) {
            if (snakeBody[i].first == x && snakeBody[i].second == y)
                gameOver = true;
        }

        // Eating food
        if (x == foodX && y == foodY) {
            score += 10;
            snakeBody.push_back({x, y});
            generateFood();
        }
    }

    void run() {
        while (!gameOver) {
            draw();
            input();
            logic();
            usleep(100000); // Speed control
        }

        system("clear||cls");
        cout << "GAME OVER!\n";
        cout << "Final Score: " << score << "\n";
    }
};

int main() {
    SnakeGame game;
    game.run();
    return 0;
}
